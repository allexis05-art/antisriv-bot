<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ê–Ω—Ç–∏—Å—Ä—ã–≤ ‚Äî Telegram Mini App</title>
  <meta name="theme-color" content="#16a34a" />
  <style>
    html,body{height:100%;margin:0}
    body{background:#fff;color:#1f2937;font-family:ui-sans-serif,system-ui,-apple-system,Roboto,Helvetica,Arial}
    body,button{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

    /* ‚úÖ –°–±—Ä–æ—Å –Ω–∞—Ç–∏–≤–Ω–æ–π —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –≤ WebView (–æ—Å–æ–±–µ–Ω–Ω–æ iOS) */
    button { -webkit-appearance:none; appearance:none; background:none; border:none; color:inherit; }
    button:focus-visible { outline:2px solid #16a34a; outline-offset:2px; }

    .page{padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    a{color:#16a34a}
    .error-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;display:none;align-items:center;justify-content:center;text-align:left;padding:24px;z-index:9999}
    .error-overlay pre{white-space:pre-wrap;max-width:860px}
    .list-table{width:100%;border-collapse:separate;border-spacing:0 12px}
    .list-table th{font-size:12px;text-align:left;color:#6b7280;font-weight:600}
    .list-table td{background:#fff}
  </style>
  <!-- Telegram Web Apps SDK (–º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Standalone –¥–ª—è JSX –≤ —ç—Ç–æ–º –¥–µ–º–æ -->
  <script>window.BABEL_DISABLE_CACHE = true;</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <div id="err" class="error-overlay"><pre id="err-msg"></pre></div>

  <script type="text/babel" data-presets="env,react">
    'use strict';

    // ====== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –æ—à–∏–±–æ–∫ ======
    (function(){
      const overlay = document.getElementById('err');
      const msg = document.getElementById('err-msg');
      window.__showFatal = (e)=>{ try{ msg.textContent = (e && (e.stack||e.message||String(e))) || 'Unknown error'; overlay.style.display='flex'; }catch(_){} };
      window.addEventListener('error', ev => { if(!/ResizeObserver/.test(String(ev?.message))) { __showFatal(ev.error || ev.message); } });
      window.addEventListener('unhandledrejection', ev => { __showFatal(ev.reason); });
    })();

    // ====== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±—Ä–µ–Ω–¥–∞ ======
    const BRAND_PRIMARY = '#16a34a'; // emerald-600
    const BRAND_PRIMARY_TEXT = '#ffffff';

    // ====== Analytics: Google Apps Script collector (—É—Å—Ç–æ–π—á–∏–≤—ã–π) ======
    const ANALYTICS_URL = 'PASTE_YOUR_GAS_EXEC_URL_HERE'; // –Ω–∞–ø—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/XXX/exec?key=YYY
    const APP_VERSION = '1.0.0';
    const __QP = new URLSearchParams(location.search);
    const DEBUG = __QP.get('debug') === '1';
    const SESSION_ID = (crypto && crypto.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random().toString(16).slice(2)));

    // —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (–¥–ª—è –∫–æ–Ω—Å–æ–ª–∏)
    window.__analyticsState = { ok: null, lastError: null, lastResponse: null };

    async function sendAnalytics(payload){
      try {
        // –®–ª—ë–º –∫–∞–∫ —Ñ–æ—Ä–º—É ‚Äî –±–µ–∑ preflight; –≤ WebView —ç—Ç–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ
        const body = new URLSearchParams({ payload: JSON.stringify(payload) });
        await fetch(ANALYTICS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8' },
          body
        });
        window.__analyticsState = { ok:true, lastError:null, lastResponse:null };
        if (DEBUG) console.log('[analytics] sent (form, opaque)', { payload });
        return { ok:true };
      } catch (e) {
        try {
          const blob = new Blob([new URLSearchParams({ payload: JSON.stringify(payload) })], { type: 'application/x-www-form-urlencoded;charset=utf-8' });
          const ok = navigator.sendBeacon ? navigator.sendBeacon(ANALYTICS_URL, blob) : false;
          window.__analyticsState = { ok, lastError: ok? null : 'sendBeacon failed', lastResponse:null };
          if (DEBUG) console.log('[analytics] sendBeacon(form)', ok);
          return { ok };
        } catch(_) {}
        window.__analyticsState = { ok:false, lastError:String(e), lastResponse:null };
        if (DEBUG) console.error('[analytics] failed', e);
        return { ok:false, error:e };
      }
    }

    async function logEvent(event, data = {}) {
      // 1) –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
      const tgUser = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) || null;
      const tgId   = tgUser ? tgUser.id : null;
      const tgName = tgUser ? [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') : null;

      // 2) –ë–µ—Ä—ë–º –∏–∑ URL –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
      const qpId   = __QP.get('uid')   || '';
      const qpName = __QP.get('uname') || '';

      // 3) –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: Telegram ‚Üí data ‚Üí query
      const userId   = (tgId != null ? String(tgId) : (data.user_id || qpId || ''));
      const userName = (tgName || data.user_name || qpName || '');

      const body = {
        event,
        ts_client: new Date().toISOString(),
        app_version: APP_VERSION,
        session_id: SESSION_ID,
        user_id: userId,
        user_name: userName,
        ...data
      };
      return sendAnalytics(body);
    }

    // ====== Helpers ======
    function get(o, path, d){
      try{ let cur=o; for(let i=0;i<path.length;i++){ if(cur==null) return d; cur=cur[path[i]]; } return (cur===undefined?d:cur); }catch(e){ return d; }
    }
    function clamp(n,min,max){return Math.max(min,Math.min(max,n))}

    // ====== Telegram shim (–¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–Ω–µ Telegram) ======
    const TG_SHIM = {
      themeParams:{},
      ready:()=>{},
      close:()=>console.log('[tg] close()'),
      openLink:(url)=>{ try{ window.open(url, '_blank','noopener'); }catch(e){ location.href=url; } },
      sendData:(d)=>console.log('[tg] sendData', d),
      MainButton:{ setParams:(p)=>console.log('[tg] MainButton.setParams',p), onClick:(fn)=>{ TG_SHIM.__mb=fn; }, offClick:(fn)=>{ if(TG_SHIM.__mb===fn) TG_SHIM.__mb=null; }, show:()=>{}, hide:()=>{} },
      onEvent:()=>{}, offEvent:()=>{}
    };

    function useTelegram(){
      const [tg,setTg] = React.useState(()=>get(window,["Telegram","WebApp"],null) || TG_SHIM);
      React.useEffect(()=>{ const t=get(window,["Telegram","WebApp"],null); if(t){ setTg(t); try{t.ready();}catch(_){} } },[]);
      return tg;
    }

    // ====== Theme (–ñ—ë—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±—Ä–µ–Ω–¥–æ–≤—ã–π –∑–µ–ª—ë–Ω—ã–π –¥–ª—è primary) ======
    function useTheme(){
      const tg = useTelegram();
      const compute = React.useCallback(()=>{
        const p = tg && tg.themeParams || {};
        const isDark = (p.bg_color && parseInt(String(p.bg_color).replace('#',''),16) < 0x888888);
        return {
          isDark,
          bg: p.bg_color || (isDark?"#0b1220":"#f8fafc"),
          text: p.text_color || (isDark?"#e5e7eb":"#111827"),
          subtext: p.hint_color || (isDark?"#9ca3af":"#6b7280"),
          primary: BRAND_PRIMARY,           // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º p.button_color ‚Üí –≤—Å–µ–≥–¥–∞ –∑–µ–ª—ë–Ω—ã–π
          primaryText: BRAND_PRIMARY_TEXT,  // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º p.button_text_color
          border: p.section_separator_color || (isDark?"#1f2937":"#e5e7eb"),
          card: isDark?"#111827":"#fff"
        }
      },[tg]);
      const [theme,setTheme] = React.useState(()=>compute());
      React.useEffect(()=>{
        if(!tg) return; const onTheme=()=>setTheme(compute());
        try{ tg.onEvent && tg.onEvent('themeChanged', onTheme); }catch(_){ }
        return ()=>{ try{ tg.offEvent && tg.offEvent('themeChanged', onTheme); }catch(_){ } }
      },[tg,compute]);
      return theme;
    }

    // ====== UI helpers ======
    function btnPrimary(theme){ return {fontSize:16,padding:"12px 16px",border:"1px solid "+(theme?.primary||'#16a34a'),background:(theme?.primary||'#16a34a'),color:(theme?.primaryText||'#fff'),borderRadius:12,cursor:"pointer",fontWeight:700} }
    function btnOutline(theme){ return {fontSize:13,padding:"8px 12px",border:"1px solid "+(theme?.border||'#e5e7eb'),background:(theme?.card||'#fff'),color:(theme?.text||'#111827'),borderRadius:10,cursor:"pointer"} }

    function Progress({value, theme}){ const v = clamp(Math.round(value),0,100); return (
      <div style={{height:8,background:"rgba(0,0,0,0.08)",borderRadius:8,overflow:"hidden"}}>
        <div style={{width:v+"%",height:"100%",background:theme.primary,transition:"width .25s ease"}} />
      </div>) }

    function Section({title,subtitle,children,theme,variant}){
      const isCheck = variant==='checkin';
      return (
        <div style={{background:theme.card,border:"1px solid "+(theme?.border||'#e5e7eb'),borderRadius:12,overflow:"hidden",marginBottom:12}}>
          <div style={{padding:"12px 14px",background:isCheck?'rgba(22,163,74,0.06)':'rgba(0,0,0,0.04)'}}>
            <div style={{fontWeight:800,fontSize:16,lineHeight:1.25}}>{title}</div>
            {subtitle && <div style={{fontSize:12,color:theme.subtext,marginTop:4}}>{subtitle}</div>}
          </div>
          <div style={{padding:12}}>{children}</div>
        </div>)
    }

    function Banner({theme,title,subtitle,level='main'}){
      const isMain = level==='main';
      return (
        <div style={{padding:'12px 14px', borderRadius:14, background:isMain?'rgba(22,163,74,0.06)':'rgba(0,0,0,0.035)', border:'1px solid '+(isMain?(theme?.primary||'#16a34a'):(theme?.border||'#e5e7eb')), marginBottom:12}}>
          <div style={{fontWeight:800,fontSize:isMain?20:16,lineHeight:1.25}}>{title}</div>
          {subtitle && <div style={{marginTop:6,fontSize:12,color:theme.subtext}}>{subtitle}</div>}
        </div>
      );
    }

    function QSection({title,subtitle,children,theme,first=false}){
      return (
        <div style={{padding:12,borderTop:first?'none':('1px solid '+(theme?.border||'#e5e7eb'))}}>
          <div style={{fontWeight:600}}>{title}</div>
          {subtitle && <div style={{fontSize:12,color:theme.subtext,marginTop:4}}>{subtitle}</div>}
          <div style={{marginTop:8}}>{children}</div>
        </div>
      );
    }

    function ChoiceBtn({label,active,onClick,theme}){
      return (
        <button onClick={onClick}
          style={{...btnOutline(theme),padding:"10px 12px",borderColor:active?theme.primary:(theme?.border||'#e5e7eb'),background:active?"rgba(22,163,74,.08)":(theme?.card||'#fff')}}>
          {label}
        </button>)
    }

    // ====== –î–∞–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—ã —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏) ======
    const HUNGER_REASONS = ["—Å–∫—É–∫–∞","—Å—Ç—Ä–µ—Å—Å","–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ","–¥–∞–≤–Ω–æ –µ–ª–∞","—É—Å—Ç–∞–ª–æ—Å—Ç—å","–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è","–¥—Ä—É–≥–æ–µ"]; 

    // ====== –•–∏–¥–µ—Ä —Å –∑–µ–ª—ë–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ ======
    function Header({theme,onOpenProtocol,onRelapse}){
      const bigOutline = {...btnOutline(theme), fontSize:16, padding:'12px 16px', borderRadius:12, fontWeight:700, borderColor:(theme?.primary||'#16a34a'), color:(theme?.text||'#111827')};
      return (
        <div style={{display:'grid',gap:8,marginBottom:16}}>
          <div style={{textAlign:'center',marginBottom:12}}>
            <div style={{fontSize:24,fontWeight:800}}>–ê–Ω—Ç–∏—Å—Ä—ã–≤</div>
            <div style={{fontSize:13,color:theme.subtext}}>–¢–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –ø—É—Ç–∏ –∫ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É –ø–∏—Ç–∞–Ω–∏—é</div>
          </div>
          <div style={{textAlign:'center',fontSize:13,fontWeight:600,color:theme.text}}>–ù–∞–∂–º–∏, –µ—Å–ª–∏</div>
          <div style={{display:'flex',gap:8,justifyContent:'center',flexWrap:'wrap'}}>
            <button onClick={onOpenProtocol} style={bigOutline}>–û—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è üî•</button>
            <button onClick={onRelapse} style={bigOutline}>–°–æ—Ä–≤–∞–ª–∞—Å—å üíî</button>
          </div>
        </div>
      )
    }

    // ====== –ü—Ä–∏–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ–∫-–∏–Ω–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞) ======
    function CheckinDemo({theme}){
      const [hunger,setHunger] = React.useState(0);
      return (
        <div style={{border:'1px solid '+(theme?.border||'#e5e7eb'),borderRadius:14,overflow:'hidden',background:(theme?.card||'#fff')}}>
          <div style={{padding:'12px 14px',background:'rgba(22,163,74,0.06)'}}>
            <div style={{fontWeight:800,fontSize:20,lineHeight:1.25}}>–ß–µ–∫‚Äë–∏–Ω</div>
            <div style={{marginTop:6,fontSize:12,color:theme.subtext}}>1 –º–∏–Ω—É—Ç–∞, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–µ–±—è</div>
          </div>
          <div style={{padding:12}}>
            <Progress value={(hunger+1)/6*100} theme={theme} />
          </div>
          <QSection theme={theme} title="–û—Ü–µ–Ω–∫–∞ –≥–æ–ª–æ–¥–∞" subtitle="0 ‚Äî —Å—ã—Ç–æ ‚Ä¶ 5 ‚Äî —Å–∏–ª—å–Ω—ã–π –≥–æ–ª–æ–¥" first>
            <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              {[0,1,2,3,4,5].map(v=> (
                <ChoiceBtn key={v} theme={theme} label={String(v)} active={hunger===v} onClick={()=>{ setHunger(v); logEvent('answer',{ flow_step:'hunger', extra:{ value:v } }); }} />
              ))}
            </div>
          </QSection>
        </div>
      );
    }

    // ====== App ======
    const App = () => {
      const theme = useTheme();
      React.useEffect(()=>{ logEvent('app_open'); },[]);
      return (
        <div style={{background:theme.bg,color:theme.text,minHeight:"100vh"}}>
          <div style={{maxWidth:560,margin:"0 auto",padding:16}}>
            <Header theme={theme} onOpenProtocol={()=>logEvent('open_protocol')} onRelapse={()=>logEvent('relapse_info_open')} />
            <CheckinDemo theme={theme} />
          </div>
        </div>
      )
    }

    // ====== –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ======
    (function mount(){
      try{
        if(typeof ReactDOM==='object' && ReactDOM.createRoot && typeof React==='object'){
          const container = document.getElementById('root');
          const root = ReactDOM.createRoot(container);
          root.render(<App />);
        } else { setTimeout(mount, 16); }
      }catch(e){ __showFatal(e); throw e; }
    })();
  </script>
</body>
</html>
