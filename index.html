<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ê–Ω—Ç–∏—Å—Ä—ã–≤ ‚Äî Telegram Mini App</title>
  <meta name="theme-color" content="#16a34a" />
  <style>
    html,body{height:100%;margin:0}
    body{background:#fff;color:#1f2937;font-family:ui-sans-serif,system-ui,-apple-system,Roboto,Helvetica,Arial}
    body,button{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .page{padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    a{color:#16a34a}
    .error-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;display:none;align-items:center;justify-content:center;text-align:left;padding:24px;z-index:9999}
    .error-overlay pre{white-space:pre-wrap;max-width:860px}
    .list-table{width:100%;border-collapse:separate;border-spacing:0 12px}
    .list-table th{font-size:12px;text-align:left;color:#6b7280;font-weight:600}
    .list-table td{background:#fff}
  </style>
  <!-- Telegram Web Apps SDK (–º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- React 18 UMD (–∑–∞–≥—Ä—É–∂–∞–µ–º –ë–ï–ó defer, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ Babel-–∫–æ–¥–∞) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Standalone –¥–ª—è JSX –≤ —ç—Ç–æ–º –¥–µ–º–æ ‚Äî —Ç–æ–∂–µ –ë–ï–ó defer -->
  <script>window.BABEL_DISABLE_CACHE = true;</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <div id="err" class="error-overlay"><pre id="err-msg"></pre></div>

  <!-- –í–ê–ñ–ù–û: —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–¥—ë—Ç –ü–û–°–õ–ï React/ReactDOM/Babel –∏ –ø–æ—Ç–æ–º—É –Ω–µ —É–ø–∏—Ä–∞–µ—Ç—Å—è –≤ –≥–æ–Ω–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <script type="text/babel" data-presets="env,react">
    'use strict';
    // ===== Error boundary (global) =====
    (function(){
      const overlay = document.getElementById('err');
      const msg = document.getElementById('err-msg');
      window.__showFatal = (e)=>{ try{ msg.textContent = (e && (e.stack||e.message||String(e))) || 'Unknown error'; overlay.style.display='flex'; }catch(_){} };
      window.addEventListener('error', ev => { if(!/ResizeObserver/.test(String(ev?.message))) { __showFatal(ev.error || ev.message); } });
      window.addEventListener('unhandledrejection', ev => { __showFatal(ev.reason); });
    })();

    // ===== Utils =====
    const BRAND_PRIMARY = '#16a34a';     // emerald-600
    const BRAND_PRIMARY_TEXT = '#ffffff';
    // --- Analytics: Google Apps Script collector ---
    const ANALYTICS_URL = 'https://script.google.com/macros/s/AKfycbxQShsQ562OAUS6e4g-z20LZLJ0SrsJU0yakyFUUpIpx0om2j4yYN3J-puDbQ19Zcfblg/exec?key=Dvhjhlkjf2033';
    // ANALYTICS_ENABLED not needed anymore (removed to avoid redeclaration)
 // e.g. https://script.google.com/.../exec?key=XXXX
    const APP_VERSION = '1.0.0';
    const __QP = new URLSearchParams(location.search);
    const INTERNAL_USER_ID = __QP.get('uid') || '';
    const INTERNAL_USER_NAME = __QP.get('uname') || '';
    const DEBUG = __QP.get('debug') === '1';
    const SESSION_ID = (crypto && crypto.randomUUID ? crypto.randomUUID() : (Date.now()+Math.random().toString(16).slice(2)));
    // ANALYTICS_ENABLED not needed anymore (removed to avoid redeclaration)

    // —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (–¥–ª—è –∫–æ–Ω—Å–æ–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏)
    window.__analyticsState = { ok: null, lastError: null, lastResponse: null };

    async function sendAnalytics(payload){
  try {
    // –®–ª—ë–º –∫–∞–∫ —Ñ–æ—Ä–º—É ‚Äî –±–µ–∑ preflight –∏ –±–µ–∑ CORS-–æ—à–∏–±–æ–∫, –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –Ω–∞ GAS
    const body = new URLSearchParams({ payload: JSON.stringify(payload) });

    await fetch(ANALYTICS_URL, {
      method: 'POST',
      // mode: 'no-cors' –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å ‚Äî –¥–ª—è —Ñ–æ—Ä–º—ã —á–∞—Å—Ç–æ –Ω–µ –Ω—É–∂–µ–Ω preflight.
      // –ù–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å CORS-–ø—Ä–æ–≤–µ—Ä–æ–∫, –æ—Å—Ç–∞–≤—å—Ç–µ:
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8' },
      body
    });

    // –í no-cors –æ—Ç–≤–µ—Ç "opaque" ‚Äî —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º.
    window.__analyticsState = { ok:true, lastError:null, lastResponse:null };
    if (DEBUG) console.log('[analytics] sent (form, opaque)');
    return { ok:true };
  } catch (e) {
    // Fallback: sendBeacon
    try {
      const blob = new Blob([new URLSearchParams({ payload: JSON.stringify(payload) })], { type: 'application/x-www-form-urlencoded;charset=utf-8' });
      const ok = navigator.sendBeacon ? navigator.sendBeacon(ANALYTICS_URL, blob) : false;
      window.__analyticsState = { ok, lastError: ok? null : 'sendBeacon failed', lastResponse:null };
      if (DEBUG) console.log('[analytics] sendBeacon(form)', ok);
      return { ok };
    } catch(_) {}
    window.__analyticsState = { ok:false, lastError:String(e), lastResponse:null };
    if (DEBUG) console.error('[analytics] failed', e);
    return { ok:false, error:e };
  }
}

    async function logEvent(event, data = {}) {
  // 1) –ø—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ Telegram
  const tgUser = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) || null;
  const tgId   = tgUser ? tgUser.id : null;
  const tgName = tgUser ? [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') : null;

  // 2) –±–µ—Ä—ë–º –∏–∑ URL –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
  const qp = new URLSearchParams(location.search);
  const qpId   = qp.get('uid')   || '';
  const qpName = qp.get('uname') || '';

  // 3) –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: Telegram ‚Üí data ‚Üí query
  const userId   = (tgId != null ? String(tgId) : (data.user_id || qpId || ''));
  const userName = (tgName || data.user_name || qpName || '');

  const body = {
    event,
    ts_client: new Date().toISOString(),
    app_version: APP_VERSION,
    session_id: SESSION_ID,
    user_id: userId,
    user_name: userName,
    ...data
  };
  return sendAnalytics(body);
}


    function get(o, path, d){
      try{ let cur=o; for(let i=0;i<path.length;i++){ if(cur==null) return d; cur=cur[path[i]]; } return (cur===undefined?d:cur); }catch(e){ return d; }
    }
    function clamp(n,min,max){return Math.max(min,Math.min(max,n))}

    // ===== Telegram shim (preview works outside Telegram) =====
    const TG_SHIM = {
      themeParams:{},
      ready:()=>{},
      close:()=>console.log('[tg] close()'),
      openLink:(url)=>{ try{ window.open(url, '_blank','noopener'); }catch(e){ location.href=url; } },
      sendData:(d)=>console.log('[tg] sendData', d),
      MainButton:{ setParams:(p)=>console.log('[tg] MainButton.setParams',p), onClick:(fn)=>{ TG_SHIM.__mb=fn; }, offClick:(fn)=>{ if(TG_SHIM.__mb===fn) TG_SHIM.__mb=null; }, show:()=>{}, hide:()=>{} },
      onEvent:()=>{}, offEvent:()=>{}
    };

    // ===== Telegram + Theme =====
    function useTelegram(){
      const [tg,setTg] = React.useState(()=>get(window,["Telegram","WebApp"],null) || TG_SHIM);
      React.useEffect(()=>{ const t=get(window,["Telegram","WebApp"],null); if(t){ setTg(t); try{t.ready();}catch(_){} } },[]);
      return tg;
    }

    function useTheme(){
      const tg = useTelegram();
      const compute = React.useCallback(()=>{
        const p = tg && tg.themeParams || {};
        const isDark = (p.bg_color && parseInt(String(p.bg_color).replace('#',''),16) < 0x888888);
        return {
          isDark,
          bg: p.bg_color || (isDark?"#0b1220":"#f8fafc"),
          text: p.text_color || (isDark?"#e5e7eb":"#111827"),
          subtext: p.hint_color || (isDark?"#9ca3af":"#6b7280"),
         // primary: p.button_color || "#16a34a", // emerald-600
         // primaryText: p.button_text_color || "#fff",
          primary: BRAND_PRIMARY,           // <-- –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–µ–ª—ë–Ω—ã–π
          primaryText: BRAND_PRIMARY_TEXT,  // <-- –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–π
          border: p.section_separator_color || (isDark?"#1f2937":"#e5e7eb"),
          card: isDark?"#111827":"#fff"
        }
      },[tg]);
      const [theme,setTheme] = React.useState(()=>compute());
      React.useEffect(()=>{
        if(!tg) return; const onTheme=()=>setTheme(compute());
        try{ tg.onEvent && tg.onEvent('themeChanged', onTheme); }catch(_){ }
        return ()=>{ try{ tg.offEvent && tg.offEvent('themeChanged', onTheme); }catch(_){ } }
      },[tg,compute]);
      return theme;
    }

    // ===== Buttons =====
    function btnPrimary(theme){ return {fontSize:16,padding:"12px 16px",border:"1px solid "+(theme?.primary||'#16a34a'),background:(theme?.primary||'#16a34a'),color:(theme?.primaryText||'#fff'),borderRadius:12,cursor:"pointer",fontWeight:700} }
    function btnOutline(theme){ return {fontSize:13,padding:"8px 12px",border:"1px solid "+(theme?.border||'#e5e7eb'),background:(theme?.card||'#fff'),color:(theme?.text||'#111827'),borderRadius:10,cursor:"pointer"} }

    // ===== Progress =====
    function Progress({value, theme}){
      const v = clamp(Math.round(value),0,100);
      return (
        <div style={{height:8,background:"rgba(0,0,0,0.08)",borderRadius:8,overflow:"hidden"}}>
          <div style={{width:v+"%",height:"100%",background:theme.primary,transition:"width .25s ease"}} />
        </div>
      )
    }

    // ===== Small UI =====
    function Section({title,subtitle,children,theme,variant}){
      const isCheck = variant==='checkin';
      return (
        <div style={{background:theme.card,border:"1px solid "+(theme?.border||'#e5e7eb'),borderRadius:12,overflow:"hidden",marginBottom:12}}>
          <div style={{padding:"12px 14px",background:isCheck?'rgba(22,163,74,0.06)':'rgba(0,0,0,0.04)'}}>
            <div style={{fontWeight:800,fontSize:16,lineHeight:1.25}}>{title}</div>
            {subtitle && <div style={{fontSize:12,color:theme.subtext,marginTop:4}}>{subtitle}</div>}
          </div>
          <div style={{padding:12}}>{children}</div>
        </div>)
    }

    function WaterSection(props){ return <Section {...props} variant='checkin'/> }

    function Banner({theme,title,subtitle,level='main'}){
      const isMain = level==='main';
      return (
        <div style={{
          padding:'12px 14px', borderRadius:14,
          background:isMain?'rgba(22,163,74,0.06)':'rgba(0,0,0,0.035)',
          border:'1px solid '+(isMain?(theme?.primary||'#16a34a'):(theme?.border||'#e5e7eb')),
          marginBottom:12
        }}>
          <div style={{fontWeight:800,fontSize:isMain?20:16,lineHeight:1.25}}>{title}</div>
          {subtitle && <div style={{marginTop:6,fontSize:12,color:theme.subtext}}>{subtitle}</div>}
        </div>
      );
    }

    function QSection({title,subtitle,children,theme,first=false}){
      return (
        <div style={{padding:12,borderTop:first?'none':('1px solid '+(theme?.border||'#e5e7eb'))}}>
          <div style={{fontWeight:600}}>{title}</div>
          {subtitle && <div style={{fontSize:12,color:theme.subtext,marginTop:4}}>{subtitle}</div>}
          <div style={{marginTop:8}}>{children}</div>
        </div>
      );
    }

    function ChoiceBtn({label,active,onClick,theme}){
      return (
        <button onClick={onClick}
          style={{...btnOutline(theme),padding:"10px 12px",borderColor:active?theme.primary:(theme?.border||'#e5e7eb'),background:active?"rgba(22,163,74,.08)":(theme?.card||'#fff')}}>
          {label}
        </button>)
    }

    // ===== Data =====
    const HUNGER_REASONS = ["—Å–∫—É–∫–∞","—Å—Ç—Ä–µ—Å—Å","–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ","–¥–∞–≤–Ω–æ –µ–ª–∞","—É—Å—Ç–∞–ª–æ—Å—Ç—å","–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è","–¥—Ä—É–≥–æ–µ"]; 
    const BINGE_CONTEXT = ["–µ–¥–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏","–∞–ª–∫–æ–≥–æ–ª—å","–≤—ã—Ö–æ–¥–Ω—ã–µ","—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π","—Å—Ç—Ä–µ—Å—Å","–ø—Ä–∏–≤—ã—á–∫–∞","–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ","–≥–∞–¥–∂–µ—Ç/–¢–í","–¥—Ä—É–≥–æ–µ"]; // –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –æ–¥–∏–Ω —Ä–∞–∑

    // ===== Header (emoji) =====
    function Header({theme,onOpenProtocol,onRelapse}){
      const bigOutline = {...btnOutline(theme), fontSize:16, padding:'12px 16px', borderRadius:12, fontWeight:700, borderColor:(theme?.primary||'#16a34a'), color:(theme?.text||'#111827')};
      return (
        <div style={{display:'grid',gap:8,marginBottom:16}}>
          <div style={{textAlign:'center',marginBottom:12}}>
            <div style={{fontSize:24,fontWeight:800}}>–ê–Ω—Ç–∏—Å—Ä—ã–≤</div>
            <div style={{fontSize:13,color:theme.subtext}}>–¢–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –ø—É—Ç–∏ –∫ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É –ø–∏—Ç–∞–Ω–∏—é</div>
          </div>
          <div style={{textAlign:'center',fontSize:13,fontWeight:600,color:theme.text}}>–ù–∞–∂–º–∏, –µ—Å–ª–∏</div>
          <div style={{display:'flex',gap:8,justifyContent:'center',flexWrap:'wrap'}}>
            <button onClick={onOpenProtocol} style={bigOutline}>–û—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è üî•</button>
            <button onClick={onRelapse} style={bigOutline}>–°–æ—Ä–≤–∞–ª–∞—Å—å üíî</button>
          </div>
        </div>
      )
    }

    // ===== Steps & state =====
    function ensureArray(val){
      if(Array.isArray(val)) return val; if(val==null) return []; return [val];
    }
    function computeSteps(state){
      const steps = ["hunger","mood","binge","binge_ctx","summary"];
      if(state.hunger>2){ steps.splice(1,0,"hunger_reason"); }
      if(state.binge!==true){ const i = steps.indexOf("binge_ctx"); if(i>-1) steps.splice(i,1); }
      return steps;
    }

    // ===== Recommendations (single prioritized block) =====
    function hasAnyReason(reasons, list){ const set=new Set(reasons.map(x=>String(x).toLowerCase().trim())); return list.some(x=>set.has(x)); }
    function buildRecommendations(state){
      const reasonsArr = ensureArray(state.hunger_reason);
      const rawReasons = reasonsArr.map(x=>String(x).toLowerCase().trim());
      const reasonsNorm = state.hunger>2 ? rawReasons : [];

      // 1) Post-binge advice (highest priority)
      if(state.binge){
        const ctx = state.binge_context||[]; const items=[];
        items.push("üíö –¢—ã —É–∂–µ –º–Ω–æ–≥–æ–µ –¥–µ–ª–∞–µ—à—å –¥–ª—è —Å–µ–±—è ‚Äî –≤–∞–∂–Ω–æ –º—è–≥–∫–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ.");
        items.push("‚è∞ –ú–æ–∂–Ω–æ –ª–µ—á—å –ø–æ—Ä–∞–Ω—å—à–µ (–¥–æ 23:00) ‚Äî –æ—Ç–¥—ã—Ö –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Ç–µ–ª–æ –∏ –∞–ø–ø–µ—Ç–∏—Ç");
        items.push("üç≥ –£—Ç—Ä–æ–º –ø–æ–¥–æ–π–¥—ë—Ç —Ç–∞—Ä–µ–ª–∫–∞ —Å –±–µ–ª–∫–æ–º –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏ —É–≥–ª–µ–≤–æ–¥–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏");
        items.push("üö∂ –ù–µ–±–æ–ª—å—à–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –ø–æ–º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–∏–∏");
        items.push("üçΩ –í–µ—á–µ—Ä–æ–º ‚Äî –æ–±—ã—á–Ω—ã–π —É–∂–∏–Ω, –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ ¬´–∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å¬ª");
        if(ctx.includes("–µ–¥–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏")) items.push("üë• –ï—Å–ª–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –∑–∞–º–µ—á–∞–µ—à—å, —Å–∫–æ–ª—å–∫–æ —Å—ä–µ–ª–∞: –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—É—é –ø–æ—Ä—Ü–∏—é, –ø–æ–ª–æ–∂–∏—Ç—å –ø—Ä–∏–±–æ—Ä—ã –∫–∞–∫ –∑–∞–∫–æ–Ω—á–∏—à—å —Å –Ω–µ–π –∏ –¥–µ–ª–∞—Ç—å –ø–∞—É–∑—ã, –±–æ–ª—å—à–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –±–µ—Å–µ–¥–µ.");
        if(ctx.includes("–∞–ª–∫–æ–≥–æ–ª—å")) items.push("üç∑–ï—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å –∞–ª–∫–æ–≥–æ–ª–µ–º –Ω–∞—á–Ω–∏ —Å –ª–µ–≥–∫–æ–π –º—è—Å–Ω–æ–π/ —Ä—ã–±–Ω–æ–π –∑–∞–∫—É—Å–∫–æ–π –∏ —Å–∞–ª–∞—Ç–∞, —á–µ—Ä–µ–¥—É–π –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ —Å –≤–æ–¥–æ–π, –≤—ã–±–∏—Ä–∞–π –Ω–µ—Å–ª–∞–¥–∫–∏–µ –∫–æ–∫—Ç–µ–π–ª–∏, —Å—É—Ö–æ–µ –≤–∏–Ω–æ –∏–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –∫—Ä–µ–ø–∫–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞ –≤ —á–∏—Å—Ç–æ–º –≤–∏–¥–µ - –∫–æ–Ω—å—è–∫, –≤–∏—Å–∫–∏, —Ä–æ–º");
        if(ctx.includes("–≤—ã—Ö–æ–¥–Ω—ã–µ")) items.push("üìÖ –ù–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –ø–æ–º–æ–≥—É—Ç: –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –±–µ–∑ –±–æ–ª—å—à–∏—Ö –ø–µ—Ä–µ—Ä—ã–≤–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –±–æ–ª—å—à–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏");
        if(ctx.includes("—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π")) items.push("üè† –ï—Å–ª–∏ –≤ –≥–æ—Å—Ç—è—Ö –Ω–µ —É–¥–æ–±–Ω–æ –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –æ—Ç –µ–¥—ã: –ø—Ä–æ–±—É–π –±–ª—é–¥–∞ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏, –µ—à—å –±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π, –¥–µ–ª–∞–π –ø–∞—É–∑—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º –±–ª—é–¥–æ–º, –ø—Ä–æ–≤–µ—Ä—è—è —É—Ä–æ–≤–µ–Ω—å –≥–æ–ª–æ–¥–∞.");
        if(["–µ–¥–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏","–≤—ã—Ö–æ–¥–Ω—ã–µ","—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π"].some(x=>ctx.includes(x))){ items.push("üëú–ï—Å–ª–∏ –ø–æ –ø–ª–∞–Ω—É –µ–¥–∞ –≤–Ω–µ –¥–æ–º–∞ –ø–æ–ª–æ–∂–∏ –≤ —Å—É–º–æ—á–∫—É –º–∏–Ω–∏-–Ω–∞–±–æ—Ä: –ø–∞–∫–µ—Ç–∏–∫ —Ç—ã–∫–≤–µ–Ω–Ω—ã—Ö —Å–µ–º–µ—á–µ–∫ ‚Äì –∫–∞–∫ –∑–∞–º–µ–Ω–∞ –¥–µ—Å–µ—Ä—Ç–∞; –ø—Å–∏–ª–ª–∏—É–º 1‚Äì2 —á. –ª. (—Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç—å –≤ –≤–æ–¥–µ –∏ –≤—ã–ø–∏—Ç—å –∑–∞ 10‚Äì20 –º–∏–Ω –¥–æ –∑–∞—Å—Ç–æ–ª—å—è) ‚Äì –ø–æ–º–æ–∂–µ—Ç –Ω–µ –ø–µ—Ä–µ–µ–¥–∞—Ç—å."); }
        return [{title:"–°–æ–≤–µ—Ç—ã –ø–æ—Å–ª–µ —Å—Ä—ã–≤–∞", items}];
      }

      // 2) Emotional: pleasures only for boredom/stress/fatigue OR bad mood
      const pleasureReasons = ["—Å–∫—É–∫–∞","—Å—Ç—Ä–µ—Å—Å","—É—Å—Ç–∞–ª–æ—Å—Ç—å"];
      if((reasonsNorm.length>0 && hasAnyReason(reasonsNorm, pleasureReasons)) || state.mood === '–ø–ª–æ—Ö–æ–µ'){
        const items=[
          "–û—Ç–≤–ª–µ–∫–∏—Å—å –∏ –≤—ã–±–µ—Ä–∏ –æ–¥–Ω–æ –¥–µ–ª–æ –∏–∑ ‚Äú–°–ø–∏—Å–∫–∞ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–π‚Äù.",
          "–ù–∞–ø—Ä–∏–º–µ—Ä:",
          "üéß –ü–æ—Å–ª—É—à–∞—Ç—å –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫",
          "üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –±–ª–∏–∑–∫–∏–º",
          "üçµ –ù–∞–ª–∏—Ç—å —á–∞–π–∫—É",
          "‚úèÔ∏è –ü–æ—á–µ—Ä—Ç–∏—Ç—å/–ø–æ—Ä–∏—Å–æ–≤–∞—Ç—å",
          "üìù –ü–æ–ø–∏—Å–∞—Ç—å –≤—Å—ë, —á—Ç–æ –ø—Ä–∏–¥—ë—Ç –≤ –≥–æ–ª–æ–≤—É",
          "üßó –ü—Ä–æ–π—Ç–∏—Å—å –ø–æ –ª–µ—Å—Ç–Ω–∏—Ü–µ",
          "üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—è—Ç–Ω–æ—Å—Ç—å –Ω–∞ –≤–µ—á–µ—Ä/–≤—ã—Ö–æ–¥–Ω—ã–µ",
        ];
        return [{title:"–í–æ–∑–º–æ–∂–µ–Ω \"—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π\" –≥–æ–ª–æ–¥", items}];
      }

      // 3) Procrastination small step
      if(hasAnyReason(reasonsNorm,["–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è"])){
        return [{title:"–ù–∞—á–Ω–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —à–∞–≥–∞", items:[
          "–ú–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –Ω–∞ 15 –º–∏–Ω—É—Ç –∏ –∑–∞–Ω—è—Ç—å—Å—è –æ–¥–Ω–æ–π –ø—Ä–æ—Å—Ç–æ–π —á–∞—Å—Ç—å—é –∑–∞–¥–∞—á–∏.",
          "–ü–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞ ‚Äî —Ä–µ—à–∏—Ç—å: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ—â—ë 15 –º–∏–Ω—É—Ç –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É.",
          "–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–µ–±—è –Ω–µ–±–æ–ª—å—à–∏–º —Ä–∏—Ç—É–∞–ª–æ–º: —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã, –ª—é–±–∏–º–∞—è –º—É–∑—ã–∫–∞, —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ —Å —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞."
        ]}];
      }

      // 4) Plate if long time since last meal (and not shown earlier)
      if(state.hunger>2 && (reasonsNorm.includes('–¥–∞–≤–Ω–æ –µ–ª–∞')) && !state.seen_plate){
        return [{title:"–ü–æ–µ—à—å)", sub:"–í–æ—Ç –∏–¥–µ–∏ –∫–∞–∫ —Å–æ–±—Ä–∞—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞—Ä–µ–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–ø–æ–ª–Ω–∏—Ç —ç–Ω–µ—Ä–≥–∏—é", items:[
          "1/4 —Ç–∞—Ä–µ–ª–∫–∏ –±–µ–ª–∫–∏ + 1/4 —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + 1/2 –æ–≤–æ—â–∏ + –Ω–µ–º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤",
          "–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä—ã–±–∞/–∫—É—Ä–∏—Ü–∞/—è–π—Ü–æ + –≥—Ä–µ—á–∫–∞/–∫–∏–Ω–æ–∞/—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π —Ö–ª–µ–± + —Å–∞–ª–∞—Ç –∏–ª–∏ –∑–∞–ø–µ—á–µ–Ω–Ω—ã–µ –æ–≤–æ—â–∏ + –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ —Å –ª–∏–º–æ–Ω–Ω—ã–º —Å–æ–∫–æ–º"
        ]}];
      }

      // 5) Wellness praise if everything is fine
      if(!state.binge && (state.mood==='—Ö–æ—Ä–æ—à–µ–µ' || state.mood==='–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ') && (state.hunger<=2)){
        return [{title:"–í—Å—ë —Ö–æ—Ä–æ—à–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ", items:[
          "–û—Ç–ª–∏—á–Ω–æ: —Å–µ–π—á–∞—Å –Ω–µ—Ç –≥–æ–ª–æ–¥–∞, –∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤–æ–µ ‚Äî —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–≤–æ—é —Ü–µ–ª—å.",
          "–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Å–≤–æ—ë–º —Ä–∏—Ç–º–µ –∏ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–º–µ—á–∞–π —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî —Ç–∞–∫–∏–µ –º–∏–Ω–∏‚Äë—á–µ–∫‚Äë–∏–Ω—ã –ø–æ–º–æ–≥–∞—é—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å —Å–æ–±–æ–π."
        ]}];
      }
      return [];
    }

    // ===== Cards =====
    function ProtocolCard({theme,onBack}){
      return (
        <Section theme={theme} title="–°—Ç–æ–ø‚Äë–ø—Ä–æ—Ç–æ–∫–æ–ª" subtitle="–ï—Å–ª–∏ —Ç—è–≥–∞ –≤—ã—Å–æ–∫–∞—è ‚Äî –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –∏ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Å–µ–π—á–∞—Å">
          <div style={{display:"grid",gap:12}}>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>–®–∞–≥ 1. –°—Ç–æ–ø ‚úã</div>
              <ul style={{paddingLeft:18,margin:0}}>
                <li>–ü–∞—É–∑–∞ 3‚Äì5 –º–∏–Ω—É—Ç ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ–∫–æ–π–Ω—ã—Ö –≤–¥–æ—Ö–æ–≤. –ú–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –ª–∞–¥–æ–Ω—å –Ω–∞ –≥—Ä—É–¥—å –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –æ–ø–æ—Ä—É.</li>
                <li>–í–æ–ø—Ä–æ—Å —Å–µ–±–µ: ¬´–ß—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî –µ–¥–∞, –æ—Ç–¥—ã—Ö, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ, –∑–∞–±–æ—Ç–∞?¬ª</li>
              </ul>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>–®–∞–≥ 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚öñÔ∏è</div>
              <ul style={{paddingLeft:18,margin:0}}>
                <li>–ü—Ä–æ—à–ª–æ –ª–∏ ~3 —á–∞—Å–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏? –ï—Å–ª–∏ –¥–∞ ‚Äî –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å–ø–æ–∫–æ–π–Ω—ã–π –ø—Ä–∏—ë–º –µ–¥—ã.</li>
              </ul>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>–®–∞–≥ 3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ üîÑ</div>
              <div style={{fontSize:14,color:theme.text,marginBottom:6}}>–ï—Å–ª–∏ –±–æ–ª—å—à–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —ç–º–æ—Ü–∏—é ‚Äî –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:</div>
              <ul style={{paddingLeft:18,margin:0}}>
                <li>üíß —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã</li>
                <li>üö∂‚Äç‚ôÄÔ∏è –∫–æ—Ä–æ—Ç–∫—É—é –ø—Ä–æ–≥—É–ª–∫—É 5‚Äì10 –º–∏–Ω—É—Ç</li>
                <li>üßò‚Äç‚ôÄÔ∏è –¥—ã—Ö–∞–Ω–∏–µ 4‚Äì7‚Äì8: –≤–¥–æ—Ö 4, –ø–∞—É–∑–∞ 7, –≤—ã–¥–æ—Ö 8</li>
                <li>üé∂ –º—É–∑—ã–∫—É, –¥—É—à –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–µ–∂–∞—Ç—å 15 –º–∏–Ω—É—Ç</li>
              </ul>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>–®–∞–≥ 4. –û—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä üçè</div>
              <ul style={{paddingLeft:18,margin:0}}>
                <li>–ï—Å–ª–∏ –≥–æ–ª–æ–¥ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π ‚Äî —Å–æ–±–µ—Ä–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Ç–∞—Ä–µ–ª–∫—É: –æ–≤–æ—â–∏/—Å–∞–ª–∞—Ç + —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + –±–µ–ª–æ–∫ + –Ω–µ–º–Ω–æ–≥–æ –∂–∏—Ä–æ–≤.</li>
                <li>–ï—Å—Ç—å –Ω–µ —Å–ø–µ—à–∞, –∑–∞–º–µ—á–∞—è –≤–∫—É—Å—ã –∏ —Å–∏–≥–Ω–∞–ª—ã —Å—ã—Ç–æ—Å—Ç–∏.</li>
                <li>–ï—Å–ª–∏ —Ç—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É –æ—Å—Ç–∞—ë—Ç—Å—è ‚Äî –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø–æ—Ä—Ü–∏—é –∏ —Å—ä–µ—Å—Ç—å –µ—ë –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç—ã –∏–ª–∏ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—É—é –ø–∞—Å—Ç–∏–ª—É).</li>
              </ul>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>–®–∞–≥ 5. –†–∞–∑–±–æ—Ä ‚úçÔ∏è</div>
              <ul style={{paddingLeft:18,margin:0}}>
                <li>–ö–æ—Ä–æ—Ç–∫–æ –æ—Ç–º–µ—Ç–∏—Ç—å: ¬´–ß—Ç–æ —è —Ö–æ—Ç–µ–ª–∞ –∑–∞–∫—Ä—ã—Ç—å? –£—Å—Ç–∞–ª–æ—Å—Ç—å? –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ? –û—Ç–¥—ã—Ö?¬ª ‚Äî –∑–∞–º–µ—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏—Ç—É–∞—Ü–∏–∏.</li>
              </ul>
            </div>
            <div style={{marginTop:4,padding:10,border:"1px dashed "+(theme?.border||'#e5e7eb'),borderRadius:12,background:"#fff"}}>
              –°–æ–≤–µ—Ç: –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å ¬´–°–ø–∏—Å–æ–∫ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–π¬ª ‚Äî –ø—Ä–æ—Å—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ 5‚Äì20 –º–∏–Ω—É—Ç –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ–¥–∞.
            </div>
            <div>
              <button onClick={onBack} style={{...btnOutline(theme),width:"100%"}}>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–µ–∫‚Äë–∏–Ω—É</button>
            </div>
          </div>
        </Section>
      );
    }

    function RelapseHelpCard({theme,onBack}){
      return (
        <Section theme={theme} title="–ï—Å–ª–∏ —Å–ª—É—á–∏–ª—Å—è —Å—Ä—ã–≤" subtitle={null}>
          <div style={{display:'grid',gap:12}}>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>1Ô∏è‚É£ –°–¥–µ–ª–∞–π –ø–∞—É–∑—É</div>
              <div>–°—Ä—ã–≤ ‚Äî –Ω–µ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞, –∞ —Ä–µ–∞–∫—Ü–∏—è –º–æ–∑–≥–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —ç–º–æ—Ü–∏–∏, —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</div>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>2Ô∏è‚É£ –ó–∞–¥–∞–π —Å–µ–±–µ —Ç—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞</div>
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–ù–∞ —á—Ç–æ —è —Å–µ–π—á–∞—Å —Å—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–∞ —Å—Ä—ã–≤–æ–º?</li>
                <li>–ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏? –ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?</li>
                <li>–ß–µ–≥–æ —è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ö–æ—Ç–µ–ª–∞ ‚Äî –æ—Ç–¥—ã—Ö–∞, —Ç–µ–ø–ª–∞, –ø–æ–¥–¥–µ—Ä–∂–∫–∏, —É–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ —á–µ–≥–æ-—Ç–æ –µ—â—ë?</li>
              </ul>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>3Ô∏è‚É£ –û—Ç–º–µ—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å</div>
              <div>–í–∞–∂–Ω–æ –Ω–∞–π—Ç–∏ –∏—Å—Ç–∏–Ω–Ω—É—é –ø—Ä–∏—á–∏–Ω—É, –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –∑–∞ —Ä–∞–º–∫–∞–º–∏ –ø—Ä–æ—Å—Ç–æ–π —Å–∏–ª—ã –≤–æ–ª–∏. –ß–∞—Å—Ç–æ —Å—Ä—ã–≤—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç, –∫–æ–≥–¥–∞ –º—ã –∏–¥—ë–º ¬´–Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏¬ª ‚Äî –∂–¥—ë–º –±—ã—Å—Ç—Ä—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–≤–µ–¥—ë—Ç –ª–∏–±–æ –∫ —Å—Ä—ã–≤—É, –ª–∏–±–æ –∫ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–æ—á–∫–µ, –ª–∏–±–æ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫–∏–ª–æ–≥—Ä–∞–º–º–∞–º –≤ –≤–∏–¥–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.</div>
              <div style={{marginTop:6}}>–ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî –Ω–µ –º–∞—Ä–∞—Ñ–æ–Ω –∏ –Ω–µ –¥–∏–µ—Ç–∞. –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —É —Ç–µ–±—è –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –ø–∏—Ç–∞–Ω–∏—è ‚Äî —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –æ–±—ã—á–∞–µ–≤, —Ç—Ä–∞–¥–∏—Ü–∏–π –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. –û–Ω–∞ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–∑–Ω–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ —Ä–∏—Ç—É–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø—Ä–∏–≤–Ω–æ—Å–∏—à—å –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å.</div>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>4Ô∏è‚É£ –ü–æ–¥–¥–µ—Ä–∂–∏ —Å–µ–±—è, –∞ –Ω–µ –∫—Ä–∏—Ç–∏–∫—É–π</div>
              <div>–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ —Ä—É–≥–∞—Ç—å —Å–µ–±—è, –∞ –Ω–∞–π—Ç–∏ —Å–ª–æ–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∫–∞–∫ –¥–ª—è —Å–∞–º–æ–≥–æ –¥–æ—Ä–æ–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞. –ú–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —Å–µ–±–µ: ¬´–°–µ–≥–æ–¥–Ω—è —è —Å–æ—Ä–≤–∞–ª–∞—Å—å, –Ω–æ —è –ø—Ä–æ–¥–æ–ª–∂–∞—é. –Ø —É–∂–µ –¥–µ–ª–∞—é –º–Ω–æ–≥–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ: –ø—å—é –±–æ–ª—å—à–µ –≤–æ–¥—ã, –∑–∞–≤—Ç—Ä–∞–∫–∞—é, –≤—ã–±–∏—Ä–∞—é –ø–æ–ª–µ–∑–Ω–æ–µ –≤—Å—ë —á–∞—â–µ, –µ–º –º–µ–Ω—å—à–µ —Å–ª–∞–¥–∫–æ–≥–æ –∏ —Ç. –¥.¬ª</div>
            </div>
            <div>
              <div style={{fontWeight:600,marginBottom:6}}>5Ô∏è‚É£ –°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã</div>
              <div>–û—Ç–º–µ—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤ —á–µ–∫‚Äë–∏–Ω–µ, —Å–¥–µ–ª–∞–π –∑–∞–º–µ—Ç–∫—É –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî —Ç–∞–∫ —Ç—ã —É—á–∏—à—å—Å—è –ø–æ–Ω–∏–º–∞—Ç—å —Å–µ–±—è, –∞ –Ω–µ –±–æ—Ä–æ—Ç—å—Å—è —Å —Å–æ–±–æ–π üíö</div>
            </div>
            <div>
              <button onClick={onBack} style={{...btnOutline(theme),width:'100%'}}>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–µ–∫‚Äë–∏–Ω—É</button>
            </div>
          </div>
        </Section>
      );
    }

    function FoodsTable({theme,title,rows}){
      return (
        <div style={{border:"1px solid "+(theme?.border||'#e5e7eb'),borderRadius:12,overflow:"hidden",background:(theme?.card||'#fff'),marginBottom:12}}>
          <div style={{padding:"10px 12px",fontWeight:700,fontSize:16,borderBottom:'1px solid '+(theme?.border||'#e5e7eb')}}>{title}</div>
          <div style={{padding:12}}>
            <table className="list-table"><tbody>
              {rows.map((r,i)=> (
                <tr key={i}>
                  <td style={{padding:"6px 8px",width:"32%",verticalAlign:'top',fontWeight:600}}>{r[0]}</td>
                  <td style={{padding:"6px 8px",verticalAlign:'top'}}>{r[1]}</td>
                </tr>
              ))}
            </tbody></table>
          </div>
        </div>
      )
    }

    function FoodsCard({theme,onBack}){
      function go(id){ try{ var el=document.getElementById(id); if(el&&el.scrollIntoView) el.scrollIntoView({behavior:'smooth',block:'start'}); }catch(_){} }
      return (
        <div style={{background:theme.card,borderRadius:16,padding:16,border:'1px solid '+(theme?.border||'#e5e7eb')}}>
          <Banner theme={theme} title="–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤" subtitle="–û—Ä–∏–µ–Ω—Ç–∏—Ä —Ç–∞—Ä–µ–ª–∫–∏: 1/2 –∫–ª–µ—Ç—á–∞—Ç–∫–∞ ¬∑ 1/4 –±–µ–ª–æ–∫ ¬∑ 1/4 —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã." level="sub" />
          <div style={{display:'flex',flexWrap:'wrap',gap:12,marginBottom:12}}>
            {[{id:'p-animal',label:'–ë–µ–ª–∫–∏'},{id:'carbs',label:'–£–≥–ª–µ–≤–æ–¥—ã'},{id:'fiber',label:'–ö–ª–µ—Ç—á–∞—Ç–∫–∞'},{id:'fats',label:'–ü–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã'}].map(link => (
              <button key={link.id} onClick={()=>go(link.id)} style={{fontSize:13,padding:0,border:'none',background:'transparent',color:(theme?.primary||'#16a34a'),textDecoration:'underline',cursor:'pointer'}}>{link.label}</button>
            ))}
          </div>
          <div style={{display:'grid',gap:12}}>
            <div id='p-animal'>
              <FoodsTable theme={theme} title='üçó –ë–ï–õ–û–ö (¬º —Ç–∞—Ä–µ–ª–∫–∏)'
                rows={[["–ú—è—Å–æ/–ø—Ç–∏—Ü–∞","–≥–æ–≤—è–¥–∏–Ω–∞, –∫—É—Ä–∏—Ü–∞, –∏–Ω–¥–µ–π–∫–∞, —Ç–µ–ª—è—Ç–∏–Ω–∞, –∫—Ä–æ–ª–∏–∫, –ø–µ—Ä–µ–ø–µ–ª–∫–∞"],["–†—ã–±–∞","–ª–æ—Å–æ—Å—å, —Ñ–æ—Ä–µ–ª—å, —Ç—É–Ω–µ—Ü, —Ç—Ä–µ—Å–∫–∞, —Å–∞—Ä–¥–∏–Ω—ã, –¥–æ—Ä–∞–¥–æ, —Å–∏–±–∞—Å"],["–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã","–∫—Ä–µ–≤–µ—Ç–∫–∏, –º–∏–¥–∏–∏, –∫–∞–ª—å–º–∞—Ä—ã"],["–Ø–π—Ü–∞","—è–π—Ü–∞ –∫—É—Ä–∏–Ω—ã–µ/–ø–µ—Ä–µ–ø–µ–ª–∏–Ω—ã–µ"],["–°—ã—Ä","–Ω–µ–∂–∏—Ä–Ω—ã–π –∫–æ–∑–∏–π —Å—ã—Ä (2‚Äì3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é)"]]} />
            </div>
            <div id='p-plant'>
              <FoodsTable theme={theme} title='üå± –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –±–µ–ª–æ–∫'
                rows={[["–ë–æ–±–æ–≤—ã–µ","—á–µ—á–µ–≤–∏—Ü–∞, –Ω—É—Ç, –º–∞—à, —Ñ–∞—Å–æ–ª—å, –≥–æ—Ä–æ—Ö"],["–ü—Å–µ–≤–¥–æ–∑–µ—Ä–Ω–æ–≤—ã–µ","–∫–∏–Ω–æ–∞, –∞–º–∞—Ä–∞–Ω—Ç, –≥—Ä–µ—á–∫–∞"],["–û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ—á–∫–∏","–º–∏–Ω–¥–∞–ª—å, –∫–µ—à—å—é, —Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏, —á–∏–∞"],["–ì—Ä–∏–±—ã","—à–∞–º–ø–∏–Ω—å–æ–Ω—ã, –≤–µ—à–µ–Ω–∫–∏"],["–°–æ–µ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã","—Ç–æ—Ñ—É, —Å–æ–µ–≤–æ–µ –º–æ–ª–æ–∫–æ"]]} />
            </div>
            <div id='carbs'>
              <FoodsTable theme={theme} title='üçö –£–ì–õ–ï–í–û–î–´ (¬º —Ç–∞—Ä–µ–ª–∫–∏) ‚Äî —Å–ª–æ–∂–Ω—ã–µ'
                rows={[["–ö—Ä—É–ø—ã","–æ–≤—Å—è–Ω–∫–∞, –≥—Ä–µ—á–∫–∞, –±—É—Ä—ã–π –∏ –¥–∏–∫–∏–π —Ä–∏—Å, –ø–µ—Ä–ª–æ–≤–∫–∞, –∫–∏–Ω–æ–∞, –ø—à–µ–Ω–æ"],["–•–ª–µ–±/–ø–∞—Å—Ç–∞","—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ —Ö–ª–µ–±—Ü—ã/–ª–∞–≤–∞—à, –ø–∞—Å—Ç–∞ –∏–∑ —Ç–≤—ë—Ä–¥—ã—Ö —Å–æ—Ä—Ç–æ–≤"],["–ë–æ–±–æ–≤—ã–µ","—Ñ–∞—Å–æ–ª—å, —á–µ—á–µ–≤–∏—Ü–∞, –≥–æ—Ä–æ—Ö"],["–ö—Ä–∞—Ö–º–∞–ª–∏—Å—Ç—ã–µ –æ–≤–æ—â–∏","–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –±–∞—Ç–∞—Ç, —Ç—ã–∫–≤–∞"]]} />
            </div>
            <div id='fiber'>
              <div style={{fontWeight:700,fontSize:16,marginBottom:8}}>ü•¶ –ö–õ–ï–¢–ß–ê–¢–ö–ê (¬Ω —Ç–∞—Ä–µ–ª–∫–∏)</div>
              <div style={{fontSize:13,color:theme.subtext,marginBottom:8}}>–ö–ª–µ—Ç—á–∞—Ç–∫–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞‚ÄºÔ∏è –ü–æ–º–æ–≥–∞–µ—Ç –∫–∏—à–µ—á–Ω–∏–∫—É, —Å–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –≥–ª—é–∫–æ–∑—ã –∏ –¥–∞—ë—Ç –Ω–∞—Å—ã—â–µ–Ω–∏–µ.</div>
              <div style={{display:'grid',gap:12}}>
                <FoodsTable theme={theme} title='–û–≤–æ—â–∏'
                  rows={[["–ö–∞–ø—É—Å—Ç—ã","–±—Ä–æ–∫–∫–æ–ª–∏, —Ü–≤–µ—Ç–Ω–∞—è, –±–µ–ª–æ–∫–æ—á–∞–Ω–Ω–∞—è, –±—Ä—é—Å—Å–µ–ª—å—Å–∫–∞—è"],["–ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã –∏ –¥—Ä.","–º–æ—Ä–∫–æ–≤—å, —Å–≤—ë–∫–ª–∞, –∫–∞–±–∞—á–æ–∫, —Ç—ã–∫–≤–∞, –±–∞—Ç–∞—Ç, —Å–µ–ª—å–¥–µ—Ä–µ–π"],["–û–≤–æ—â–∏ —Å –º–µ–Ω—å—à–µ–π –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π","—Ä–µ–¥–∏—Å, –æ–≥—É—Ä–µ—Ü, –ø–æ–º–∏–¥–æ—Ä, –ø–µ—Ä–µ—Ü"]]} />
                <FoodsTable theme={theme} title='–ó–µ–ª–µ–Ω—å'
                  rows={[["–ü—Ä–∏–º–µ—Ä—ã","–ø–µ—Ç—Ä—É—à–∫–∞, —É–∫—Ä–æ–ø, –∫–∏–Ω–∑–∞, –∑–µ–ª—ë–Ω—ã–π –ª—É–∫, –ª–∏—Å—Ç—å—è —Å–∞–ª–∞—Ç–∞, —Ä—É–∫–∫–æ–ª–∞, —à–ø–∏–Ω–∞—Ç, —â–∞–≤–µ–ª—å, –±–∞–∑–∏–ª–∏–∫, –º–∞–Ω–≥–æ–ª—å–¥, –∫–µ–π–ª"]]} />
                <FoodsTable theme={theme} title='–§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã'
                  rows={[["–ë–æ–ª—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏","—è–±–ª–æ–∫–∏ —Å –∫–æ–∂—É—Ä–æ–π, –≥—Ä—É—à–∏ —Å –∫–æ–∂—É—Ä–æ–π, –ø–µ—Ä—Å–∏–∫–∏, –∏–Ω–∂–∏—Ä, —Ö—É—Ä–º–∞, –∞–π–≤–∞, –∫–∏–≤–∏"],["–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ","–∞–ø–µ–ª—å—Å–∏–Ω, –º–∞–Ω–¥–∞—Ä–∏–Ω, –≥—Ä–µ–π–ø—Ñ—Ä—É—Ç, –±–∞–Ω–∞–Ω, –Ω–µ–∫—Ç–∞—Ä–∏–Ω, –ø–µ—Ä—Å–∏–∫, —Å–ª–∏–≤–∞, –∞–±—Ä–∏–∫–æ—Å, –≥—Ä–∞–Ω–∞—Ç"],["–ú–µ–Ω—å—à–µ –∫–ª–µ—Ç—á–∞—Ç–∫–∏","–∞–Ω–∞–Ω–∞—Å, –∞—Ä–±—É–∑, –¥—ã–Ω—è, –º–∞–Ω–≥–æ, –ø–∞–ø–∞–π—è"],["–Ø–≥–æ–¥—ã","–º–∞–ª–∏–Ω–∞, —á–µ—Ä–Ω–∏–∫–∞, –∫–ª—é–∫–≤–∞, –µ–∂–µ–≤–∏–∫–∞, –∫–ª—É–±–Ω–∏–∫–∞, –≥–æ–ª—É–±–∏–∫–∞, —Å–º–æ—Ä–æ–¥–∏–Ω–∞"]]} />
                <FoodsTable theme={theme} title='–ë–æ–±–æ–≤—ã–µ –∏ —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ (–∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–ª–µ—Ç—á–∞—Ç–∫–∏)'
                  rows={[["–ë–æ–±–æ–≤—ã–µ","—á–µ—á–µ–≤–∏—Ü–∞, –Ω—É—Ç, —Ñ–∞—Å–æ–ª—å"],["–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ","–æ–≤—Å—è–Ω–∫–∞, –≥—Ä–µ—á–∫–∞, –∫–∏–Ω–æ–∞, –ø—à–µ–Ω–æ, –±—É—Ä—ã–π —Ä–∏—Å, –æ—Ç—Ä—É–±–∏, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ —Ö–ª–µ–±—Ü—ã, —Å–µ–º–µ–Ω–∞ –ª—å–Ω–∞ –∏ —á–∏–∞, –ø—Å–∏–ª–ª–∏—É–º"]]} />
              </div>
            </div>
            <div id='fats'>
              <FoodsTable theme={theme} title='ü´í –ü–û–õ–ï–ó–ù–´–ï –ñ–ò–†–´'
                rows={[["–†—ã–±–∞","–ª–æ—Å–æ—Å—å, —Ñ–æ—Ä–µ–ª—å, —Å–∫—É–º–±—Ä–∏—è, —Å–∞—Ä–¥–∏–Ω—ã"],["–ú–∞—Å–ª–∞","–æ–ª–∏–≤–∫–æ–≤–æ–µ, –ª—å–Ω—è–Ω–æ–µ, –∫–æ–∫–æ—Å–æ–≤–æ–µ, –∫—É–Ω–∂—É—Ç–Ω–æ–µ, —Ç—ã–∫–≤–µ–Ω–Ω–æ–µ, –∏–∑ –≤–∏–Ω–æ–≥—Ä–∞–¥–Ω–æ–π –∫–æ—Å—Ç–æ—á–∫–∏, –∞–≤–æ–∫–∞–¥–æ –∏ –¥—Ä—É–≥–∏–µ —Å—ã—Ä–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ"],["–û—Ä–µ—Ö–∏","–≥—Ä–µ—Ü–∫–∏–µ, –º–∏–Ω–¥–∞–ª—å, –∫–µ—à—å—é"],["–°–µ–º–µ–Ω–∞","–ª—ë–Ω, –∫—É–Ω–∂—É—Ç, —á–∏–∞"],["–î—Ä—É–≥–æ–µ","–º–∞—Å–ª–æ –ì–•–ò, –∞–≤–æ–∫–∞–¥–æ"]]} />
            </div>
          </div>
          <div style={{marginTop:8}}>
            <button onClick={onBack} style={{...btnOutline(theme),width:'100%'}}>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–µ–∫‚Äë–∏–Ω—É</button>
          </div>
        </div>
      );
    }

    function WaterCard({theme,onBack}){
      return (
        <div style={{background:theme.card,borderRadius:16,padding:16,border:'1px solid '+(theme?.border||'#e5e7eb')}}>
          <Banner theme={theme} title="–ì–∞–π–¥ –ø–æ –≤–æ–¥–µ" subtitle="–ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" level="sub" />
          <div style={{display:'grid',gap:12}}>
            {/* 1Ô∏è‚É£ –°–∫–æ–ª—å–∫–æ –≤–æ–¥—ã */}
            <WaterSection theme={theme} title="1Ô∏è‚É£ –°–∫–æ–ª—å–∫–æ –≤–æ–¥—ã" >
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–°—Ç–∞—Ä–∞–π—Å—è –ø–∏—Ç—å <b>25‚Äì40 –º–ª/–∫–≥ –≤–µ—Å–∞</b>, –¥–∞–∂–µ –µ—Å–ª–∏ –∂–∞–∂–¥–∞ –Ω–µ –æ—â—É—â–∞–µ—Ç—Å—è.</li>
              </ul>
              <div style={{marginTop:6}}>üëâ –ï—Å–ª–∏ —Å–∏–ª—å–Ω–æ –Ω–µ –¥–æ–±–∏—Ä–∞—Ç—å, –≤–æ–∑–º–æ–∂–Ω—ã —É—Å—Ç–∞–ª–æ—Å—Ç—å, –≥–æ–ª–æ–≤–Ω—ã–µ –±–æ–ª–∏, <b>–ª–æ–∂–Ω—ã–π –≥–æ–ª–æ–¥</b> –∏ —Ä–∏—Å–∫ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è.</div>
            </WaterSection>
            {/* 2Ô∏è‚É£ –ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∂–∏–¥–∫–æ—Å—Ç—å—é ‚Äî –≤—Å–µ –ø—É–Ω–∫—Ç—ã —Å —ç–º–æ–¥–∑–∏ ‚Üí –±–µ–∑ –º–∞—Ä–∫–µ—Ä–æ–≤ */}
            <WaterSection theme={theme} title="2Ô∏è‚É£ –ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∂–∏–¥–∫–æ—Å—Ç—å—é">
              <ul style={{margin:0,paddingLeft:0,listStyle:'none'}}>
                <li>‚úÖ –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º: –≤–æ–¥–∞, –Ω–µ—Å–ª–∞–¥–∫–∏–π —á–∞–π/–∫–æ—Ñ–µ, –º–æ—Ä—Å—ã, —Å—É–ø—ã.</li>
                <li style={{marginTop:6}}>‚ùå –ù–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º: —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏, –∞–ª–∫–æ–≥–æ–ª—å ‚Äî –æ–Ω–∏ –¥–µ–≥–∏–¥—Ä–∞—Ç–∏—Ä—É—é—Ç.</li>
              </ul>
            </WaterSection>
            {/* 3Ô∏è‚É£ –£—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ä—Ç */}
            <WaterSection theme={theme} title="3Ô∏è‚É£ –£—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ä—Ç">
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–ù–∞—á–∏–Ω–∞–π –¥–µ–Ω—å —Å–æ <b>—Å—Ç–∞–∫–∞–Ω–∞‚Äë–¥–≤—É—Ö –≤–æ–¥—ã</b> –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –õ—É—á—à–µ <b>–≥–æ—Ä—è—á—É—é</b> (–Ω–µ –∫–∏–ø—è—Ç–æ–∫), –ª–∏–º–æ–Ω ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é.</li>
              </ul>
              <div style={{marginTop:6}}>üëâ –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –æ–±–º–µ–Ω –Ω–∞ 20‚Äì30%, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ñ–ö–¢, –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ –∏ —É–≤–ª–∞–∂–Ω—è–µ—Ç –∫–æ–∂—É.</div>
            </WaterSection>
            {/* 4Ô∏è‚É£ –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ */}
            <WaterSection theme={theme} title="4Ô∏è‚É£ –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è">
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–ü–µ–π —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ: <b>6‚Äì10 –ø—Ä–∏—ë–º–æ–≤</b> –≤ –¥–µ–Ω—å, –º–µ–Ω—å—à–µ –∑–∞ 2‚Äì3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞.</li>
                <li style={{marginTop:6}}>–ù–µ –±–æ–ª—å—à–µ <b>300 –º–ª –∑–∞ —Ä–∞–∑</b> –∏ –Ω–µ –∑–∞–ª–ø–æ–º.</li>
              </ul>
              <div style={{marginTop:6}}>üëâ –¢–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø–æ—á–∫–∏ –∏ –º–æ—á–µ–≤–æ–π –ø—É–∑—ã—Ä—å.</div>
            </WaterSection>
            {/* 5Ô∏è‚É£ –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π –ø–æ–¥ —É—Å–ª–æ–≤–∏—è */}
            <WaterSection theme={theme} title="5Ô∏è‚É£ –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π –ø–æ–¥ —É—Å–ª–æ–≤–∏—è">
              <div>–ë–æ–ª—å—à–µ –≤–æ–¥—ã –≤ –∂–∞—Ä—É, –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å—É—Ö–æ–º –≤–æ–∑–¥—É—Ö–µ, –Ω–∞ –≤—ã—Å–æ—Ç–µ ‚Äî –ø–æ—Ç–µ—Ä–∏ –≤—ã—à–µ, –±–∞–∑–æ–≤–æ–π –Ω–æ—Ä–º—ã –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∞—Ç—å.</div>
            </WaterSection>
            {/* 6Ô∏è‚É£ –°–ø–æ—Ä—Ç –∏ –≤–æ–¥–∞ */}
            <WaterSection theme={theme} title="6Ô∏è‚É£ –°–ø–æ—Ä—Ç –∏ –≤–æ–¥–∞">
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–ó–∞ 1‚Äì2 —á–∞—Å–∞ –¥–æ ‚Äî <b>300‚Äì500 –º–ª</b>.</li>
                <li style={{marginTop:6}}>–í–æ –≤—Ä–µ–º—è ‚Äî –ø–æ –∂–∞–∂–¥–µ.</li>
                <li style={{marginTop:6}}>–ü–æ—Å–ª–µ ‚Äî –≤–æ—Å–ø–æ–ª–Ω–∏ <b>1.25‚Äì1.5 –ª/–∫–≥ –ø–æ—Ç–µ—Ä–∏</b>.</li>
              </ul>
            </WaterSection>
            {/* 7Ô∏è‚É£ –£–≤–µ–ª–∏—á–∏–≤–∞–π –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ */}
            <WaterSection theme={theme} title="7Ô∏è‚É£ –£–≤–µ–ª–∏—á–∏–≤–∞–π –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ">
              <ul style={{margin:0,paddingLeft:18}}>
                <li>–ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –ø–∏–ª–∞ –º–∞–ª–æ ‚Äî –¥–æ–±–∞–≤–ª—è–π <b>300‚Äì500 –º–ª</b> –∫–∞–∂–¥—ã–µ 2‚Äì3 –¥–Ω—è, –º–∞–∫—Å–∏–º—É–º ‚Äî –¥–æ 4 –ª/—Å—É—Ç–∫–∏.</li>
              </ul>
              <div style={{marginTop:6}}>üëâ –¢–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–º—É –ª–µ–≥—á–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –º–µ–Ω—å—à–µ —Ä–∏—Å–∫ –æ—Ç—ë–∫–æ–≤.</div>
            </WaterSection>
            {/* 8Ô∏è‚É£ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –º–∞—Ä–∫–µ—Ä—ã */}
            <WaterSection theme={theme} title="8Ô∏è‚É£ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –º–∞—Ä–∫–µ—Ä—ã">
              <ul style={{margin:0,paddingLeft:0,listStyle:'none'}}>
                <li>‚úÖ –°–≤–µ—Ç–ª–æ‚Äë—Å–æ–ª–æ–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –º–æ—á–∏.</li>
                <li style={{marginTop:6}}>‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∫–∏—à–µ—á–Ω–∏–∫–∞ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ ‚Äî –ø–æ —á–∏—Å–ª—É –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏, –º–∏–Ω–∏–º—É–º ‚Äî 1 —Ä–∞–∑/–¥–µ–Ω—å).</li>
                <li style={{marginTop:6}}>‚úÖ –ù–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π –∂–∞–∂–¥—ã, –≥–æ–ª–æ–≤–∞ —è—Å–Ω–∞—è, –Ω–æ—á—å—é –Ω–µ –ø—Ä–æ—Å—ã–ø–∞–µ—à—å—Å—è –∏–∑‚Äë–∑–∞ –∂–∞–∂–¥—ã.</li>
              </ul>
            </WaterSection>
            {/* 9Ô∏è‚É£ –ó–∞–±–æ—Ç–∞ –æ –ñ–ö–¢ */}
            <WaterSection theme={theme} title="9Ô∏è‚É£ –ó–∞–±–æ—Ç–∞ –æ –ñ–ö–¢">
              <div>–î–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ –∂–µ–ª—á–µ–æ—Ç—Ç–æ–∫–∞ –Ω—É–∂–Ω–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–æ–¥–∞. –î–æ–±–∞–≤–ª—è–π <b>–∫–ª–µ—Ç—á–∞—Ç–∫—É</b> + <b>–¥–≤–∏–∂–µ–Ω–∏–µ</b> + <b>–ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã</b> (—Å—ã—Ä–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ –º–∞—Å–ª–∞, –æ—Ä–µ—Ö–∏, —Ä—ã–±–∞).</div>
            </WaterSection>
            {/* üîü –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ */}
            <WaterSection theme={theme} title="üîü –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏">
              <div>–ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –ø–æ—á–µ–∫, —Å–µ—Ä–¥—Ü–∞, —ç–Ω–¥–æ–∫—Ä–∏–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è, –∫–∞–º–Ω–∏ ‚Äî –Ω–æ—Ä–º–∞ <b>–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</b>, –æ–±—Å—É–¥–∏ –µ—ë —Å –ª–µ—á–∞—â–∏–º –≤—Ä–∞—á–æ–º.</div>
            </WaterSection>
            {/* –ë—ã—Å—Ç—Ä–∞—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏ */}
            <WaterSection theme={theme} title="–ë—ã—Å—Ç—Ä–∞—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞">
              <ul style={{margin:0,paddingLeft:0,listStyle:'none'}}>
                <li>‚úÖ –ù–µ—Ç —Å–∏–ª—å–Ω–æ–π –∂–∞–∂–¥—ã, –≥–æ–ª–æ–≤–∞ —è—Å–Ω–∞—è.</li>
                <li style={{marginTop:6}}>‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–ø–æ—Ä–æ–∂–Ω–µ–Ω–∏–µ –∫–∏—à–µ—á–Ω–∏–∫–∞.</li>
                <li style={{marginTop:6}}>‚úÖ –ú–æ—á–∞ —Å–≤–µ—Ç–ª–æ‚Äë—Å–æ–ª–æ–º–µ–Ω–Ω–∞—è.</li>
                <li style={{marginTop:6}}>‚úÖ –ù–µ—Ç –Ω–æ—á–Ω—ã—Ö –ø–æ–¥—ä—ë–º–æ–≤ (–∏–ª–∏ –æ–Ω–∏ —Ä–µ–¥–∫–∏–µ).</li>
              </ul>
            </WaterSection>
            {/* –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ ‚Äî –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏ */}
            <WaterSection theme={theme} title="–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏">
              <ul style={{margin:0,paddingLeft:0,listStyle:'none'}}>
                <li>‚õî –î–æ–≥–æ–Ω—è—Ç—å –Ω–æ—Ä–º—É –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.</li>
                <li style={{marginTop:6}}>‚õî –ü–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–∞–π/–∫–æ—Ñ–µ/—Å–æ–∫–∏.</li>
                <li style={{marginTop:6}}>‚õî –ü–∏—Ç—å –±–æ–ª—å—à–µ 300 –º–ª –∑–∞ —Ä–∞–∑, –∑–∞–ª–ø–æ–º –∏–ª–∏ –±–æ–ª—å—à–∏–º–∏ –≥–ª–æ—Ç–∫–∞–º–∏.</li>
                <li style={{marginTop:6}}>‚õî –î—É–º–∞—Ç—å, —á—Ç–æ –≤–æ–¥–∞ —Ä–µ—à–∏—Ç –≤—Å—ë –±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏—è.</li>
                <li style={{marginTop:6}}>‚õî –†–µ–∑–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤–æ–¥—ã –ø–æ—Å–ª–µ –º–∞–ª—ã—Ö –æ–±—ä—ë–º–æ–≤.</li>
              </ul>
            </WaterSection>
          </div>
          <div style={{marginTop:8}}>
            <button onClick={onBack} style={{...btnOutline(theme),width:'100%'}}>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–µ–∫‚Äë–∏–Ω—É</button>
          </div>
        </div>
      );
    }

    function DoneCard({theme,state,onRestart}){
      const blocks = buildRecommendations(state);
      React.useEffect(()=>{ try{ if(blocks && blocks[0]){ logEvent('checkin_done', { hunger: state.hunger, reasons: ensureArray(state.hunger_reason), mood: state.mood, binge: state.binge, binge_context: state.binge_context||[], recommendation_block: blocks[0].title }); } }catch(_){ } }, []);
      return (
        <div style={{display:"grid",gap:12}}>
          {blocks.map((b,i)=> (
            <Section key={i} theme={theme} title={b.title} subtitle={b.sub}>
              <div>
                {b.items.map((x,idx)=> (
                  <div key={idx} style={{margin:'6px 0'}}>{x}</div>
                ))}
              </div>
            </Section>
          ))}
          <div>
            <button onClick={onRestart} style={{...btnOutline(theme),width:"100%"}}>‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–µ–∫‚Äë–∏–Ω—É</button>
          </div>
        </div>
      )
    }

    function CheckinCard({theme,i,step,state,setState,next,back,onRestart}){
      const steps = computeSteps(state);
      const total = steps.length;
      const pct = total? Math.round(((i+1)/total)*100) : 0;
      const stepName = steps[i] || 'summary';

      React.useEffect(()=>{ try{ logEvent('step_shown', { flow_step: stepName }); }catch(_){ } }, [stepName]);

      if(step==='summary'){
        return (
          <div className="page" style={{display:'grid',gap:12}}>
            <DoneCard theme={theme} state={state} onRestart={onRestart} />
          </div>
        );
      }

      const greenBg = 'rgba(22,163,74,0.06)';

      return (
        <div className="page">
          <div style={{border:'1px solid '+(theme?.border||'#e5e7eb'),borderRadius:14,overflow:'hidden',background:(theme?.card||'#fff')}}>
            {/* –®–∞–ø–∫–∞ —á–µ–∫‚Äë–∏–Ω–∞ */}
            <div style={{padding:'12px 14px',background:greenBg}}>
              <div style={{fontWeight:800,fontSize:20,lineHeight:1.25}}>–ß–µ–∫‚Äë–∏–Ω</div>
              <div style={{marginTop:6,fontSize:12,color:theme.subtext}}>1 –º–∏–Ω—É—Ç–∞, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Å–µ–±—è</div>
            </div>

            {/* –ü—Ä–æ–≥—Ä–µ—Å—Å */}
            <div style={{padding:12}}>
              <Progress value={pct} theme={theme} />
            </div>

            {/* –®–∞–≥–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ */}
            {step==='hunger' && (
              <QSection theme={theme} title="–û—Ü–µ–Ω–∫–∞ –≥–æ–ª–æ–¥–∞" subtitle="0 ‚Äî —Å—ã—Ç–æ; 2 ‚Äî –ª—ë–≥–∫–∏–π –≥–æ–ª–æ–¥, –º—ã—Å–ª–∏ –æ –µ–¥–µ; 5 ‚Äî —Å–∏–ª—å–Ω—ã–π –≥–æ–ª–æ–¥ (—Å–ª–∞–±–æ—Å—Ç—å)" first>
                <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                  {[0,1,2,3,4,5].map(v=> (
                    <ChoiceBtn key={v} theme={theme} label={String(v)} active={state.hunger===v} onClick={()=>{ setState(s=>({...s,hunger:v})); logEvent('answer',{ flow_step:'hunger', extra:{ value:v } }); }} />
                  ))}
                </div>
              </QSection>
            )}

            {step==='hunger_reason' && (
              <>
                <QSection theme={theme} title="–ü–æ—á–µ–º—É —Ç–∞–∫–∞—è –æ—Ü–µ–Ω–∫–∞?" subtitle="–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤" first>
                  <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                    {HUNGER_REASONS.map(r=> {
                      const active = ensureArray(state.hunger_reason).includes(r);
                      return (
                        <ChoiceBtn key={r} theme={theme} label={r} active={active}
                          onClick={()=>{ const arr=ensureArray(state.hunger_reason); const set=new Set(arr); if(set.has(r)) set.delete(r); else set.add(r); const next=[...set]; setState(s=>({...s,hunger_reason:next, seen_plate: set.has('–¥–∞–≤–Ω–æ –µ–ª–∞')? true : s.seen_plate})); logEvent('answer',{ flow_step:'hunger_reason', extra:{ value: next } }); }} />
                      );
                    })}
                  </div>
                </QSection>
                {ensureArray(state.hunger_reason).includes('–¥–∞–≤–Ω–æ –µ–ª–∞') && (
                  <QSection theme={theme} title="–ü–æ–µ—à—å)" subtitle={<span style={{fontSize:12,color:theme.subtext}}>–í–æ—Ç –∏–¥–µ–∏ –∫–∞–∫ —Å–æ–±—Ä–∞—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞—Ä–µ–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–ø–æ–ª–Ω–∏—Ç —ç–Ω–µ—Ä–≥–∏—é</span>}>
                    <div style={{display:'grid',gap:6}}>
                      <div>1/4 —Ç–∞—Ä–µ–ª–∫–∏ –±–µ–ª–∫–∏ + 1/4 —Å–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã + 1/2 –æ–≤–æ—â–∏ + –Ω–µ–º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω—ã—Ö –∂–∏—Ä–æ–≤</div>
                      <div>–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä—ã–±–∞/–∫—É—Ä–∏—Ü–∞/—è–π—Ü–æ + –≥—Ä–µ—á–∫–∞/–∫–∏–Ω–æ–∞/—Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π —Ö–ª–µ–± + —Å–∞–ª–∞—Ç –∏–ª–∏ –∑–∞–ø–µ—á–µ–Ω–Ω—ã–µ –æ–≤–æ—â–∏ + –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ —Å –ª–∏–º–æ–Ω–Ω—ã–º —Å–æ–∫–æ–º</div>
                    </div>
                  </QSection>
                )}
              </>
            )}

            {step==='mood' && (
              <QSection theme={theme} title="–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ" first>
                <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                  {['—Ö–æ—Ä–æ—à–µ–µ','–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ','–ø–ª–æ—Ö–æ–µ'].map(r=> (
                    <ChoiceBtn key={r} theme={theme} label={r} active={state.mood===r} onClick={()=>{ setState(s=>({...s,mood:r})); logEvent('answer',{ flow_step:'mood', extra:{ value:r } }); }} />
                  ))}
                </div>
              </QSection>
            )}

            {step==='binge' && (
              <QSection theme={theme} title="–ë—ã–ª –ª–∏ —Å—Ä—ã–≤/–ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ?" subtitle="–ï—Å–ª–∏ –¥–∞ ‚Äî –¥–≤–∏–≥–∞–µ–º—Å—è –º—è–≥–∫–æ, –±–µ–∑ –Ω–∞–∫–∞–∑–∞–Ω–∏–π" first>
                <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                  {[true,false].map(v=> (
                    <ChoiceBtn key={String(v)} theme={theme} label={v?'–¥–∞':'–Ω–µ—Ç'} active={state.binge===v} onClick={()=>{ setState(s=>({...s,binge:v})); logEvent('answer',{ flow_step:'binge', extra:{ value:v } }); }} />
                  ))}
                </div>
              </QSection>
            )}

            {step==='binge_ctx' && (
              <QSection theme={theme} title="–ß—Ç–æ –ø–æ—Å–ª—É–∂–∏–ª–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–º? –ß—Ç–æ –ø—Ä–µ–¥—à–µ—Å—Ç–≤–æ–≤–∞–ª–æ —Å—Ä—ã–≤—É?" subtitle={<span style={{fontSize:12,color:theme.subtext}}>–û—Ç–º–µ—á–∞–π –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –ø—Ä–∏—á–∏–Ω—ã ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥—É–≥–∞–¥—ã–≤–∞—Ç—å —Å—Ä—ã–≤—ã</span>} first>
                <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
                  {BINGE_CONTEXT.map(r=>{
                    const active = (state.binge_context||[]).includes(r);
                    return (
                      <ChoiceBtn key={r} theme={theme} label={r} active={active}
                        onClick={()=>{ const set=new Set(state.binge_context||[]); if(set.has(r)) set.delete(r); else set.add(r); const next=[...set]; setState(s=>({...s,binge_context:next})); logEvent('answer',{ flow_step:'binge_context', extra:{ value: next } }); }} />
                    );
                  })}
                </div>
              </QSection>
            )}

            {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
            <div style={{display:'flex',gap:8,padding:12}}>
              <button style={btnOutline(theme)} onClick={back}>–ù–∞–∑–∞–¥</button>
              <button style={btnPrimary(theme)} onClick={next}>–î–∞–ª—å—à–µ</button>
            </div>
          </div>
        </div>
      )
    }

    // ===== Diagnostics (tests) =====
    function runTests(){
      const results = [];
      function t(name, fn){ try{ fn(); results.push({name, ok:true}); } catch(e){ console.error('[TEST FAIL]', name, e); results.push({name, ok:false, err:String(e)}); } }
      t('computeSteps: hunger<=2 skips reason', ()=>{ const steps=computeSteps({hunger:2,binge:false}); if(steps.includes('hunger_reason')) throw new Error('reason should be skipped'); });
      t('computeSteps: hunger>2 adds reason', ()=>{ const steps=computeSteps({hunger:3,binge:false}); if(!steps.includes('hunger_reason')) throw new Error('reason missing'); });
      t('computeSteps: binge true includes binge_ctx', ()=>{ const steps=computeSteps({hunger:0,binge:true}); if(!steps.includes('binge_ctx')) throw new Error('binge_ctx missing'); });
      t('buildRecommendations: mood bad adds pleasures', ()=>{ const r=buildRecommendations({binge:false,mood:'–ø–ª–æ—Ö–æ–µ',hunger:0}); const has=r.some(b=>b.title.includes('—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π')); if(!has) throw new Error('pleasures missing'); });
      t('buildRecommendations: long hunger reason plate', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:3,hunger_reason:'–¥–∞–≤–Ω–æ –µ–ª–∞'}); const has=r.some(b=>b.title.includes('–ü–æ–µ—à—å')); if(!has) throw new Error('plate missing'); });
      t('buildRecommendations: binge contexts add seeds+psyllium', ()=>{ const r=buildRecommendations({binge:true,binge_context:['–≤—ã—Ö–æ–¥–Ω—ã–µ'],mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:0}); const has=r.some(b=>b.items.join(' ').includes('–ø–∞–∫–µ—Ç–∏–∫ —Ç—ã–∫–≤–µ–Ω–Ω—ã—Ö —Å–µ–º–µ—á–µ–∫')); if(!has) throw new Error('seeds+psyllium missing'); });
      t('buildRecommendations: no standalone support block', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:0}); const has=r.some(b=>b.title==='–ü–æ–¥–¥–µ—Ä–∂–∫–∞'); if(has) throw new Error('standalone support block should not exist'); });
      t('component exists: FoodsTable', ()=>{ if(typeof FoodsTable !== 'function') throw new Error('FoodsTable missing'); });
      t('component exists: WaterCard', ()=>{ if(typeof WaterCard !== 'function') throw new Error('WaterCard missing'); });
      t('component exists: DoneCard', ()=>{ if(typeof DoneCard !== 'function') throw new Error('DoneCard missing'); });
      t('buildRecommendations: binge true returns unified advice block', ()=>{ const r=buildRecommendations({binge:true,binge_context:[],mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:0}); const has=r.some(b=>b.title==='–°–æ–≤–µ—Ç—ã –ø–æ—Å–ª–µ —Å—Ä—ã–≤–∞' && b.items.some(x=>/–º–Ω–æ–≥–æ–µ –¥–µ–ª–∞–µ—à—å|—Å–≤–æ—ë–º —Ç–µ–º–ø–µ/.test(x))); if(!has) throw new Error('unified supportive advice missing'); });
      t('priority: binge advice outranks mood bad', ()=>{ const r=buildRecommendations({binge:true,mood:'–ø–ª–æ—Ö–æ–µ',hunger:0,binge_context:[]}); if(!(r.length===1 && r[0].title==='–°–æ–≤–µ—Ç—ã –ø–æ—Å–ª–µ —Å—Ä—ã–≤–∞')) throw new Error('binge should have priority'); });
      t('no duplicate plate when seen earlier', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:3,hunger_reason:['–¥–∞–≤–Ω–æ –µ–ª–∞'],seen_plate:true}); const has=r.some(b=>b.title.includes('–ü–æ–µ—à—å')); if(has) throw new Error('plate should be suppressed when seen'); });
      t('wellness praise when no hunger, neutral/good mood, no binge', ()=>{ const r=buildRecommendations({hunger:0,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',binge:false}); if(!(r.length===1 && (/–í—Å—ë —Ö–æ—Ä–æ—à–æ|–ø—Ä–æ–¥–æ–ª–∂–∞–π/.test(r[0].title) || r[0].items.some(x=>/–ø—Ä–æ–¥–æ–ª–∂–∞–π|–º–∏–Ω–∏‚Äë—á–µ–∫‚Äë–∏–Ω—ã/.test(x))))) throw new Error('wellness block missing'); });
      t('reason —Å–∫—É–∫–∞ triggers pleasures', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:3,hunger_reason:['–°–∫—É–∫–∞']}); if(!(r.length===1 && r[0].title.includes('—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π'))) throw new Error('skuka should show pleasures'); });
      t('reason —É—Å—Ç–∞–ª–æ—Å—Ç—å triggers pleasures', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:3,hunger_reason:['—É—Å—Ç–∞–ª–æ—Å—Ç—å']}); if(!(r.length===1 && r[0].title.includes('—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π'))) throw new Error('ustalost should show pleasures'); });
      t('reason –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è shows small step advice', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:3,hunger_reason:['–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è']}); const has=r.some(b=>b.title==='–ù–∞—á–Ω–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —à–∞–≥–∞' && b.items.join(' ').includes('15 –º–∏–Ω—É—Ç')); if(!has) throw new Error('procrastination advice missing'); });
      t('binge context: –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ appears once', ()=>{ const count = BINGE_CONTEXT.filter(x=>x==='–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ').length; if(count!==1) throw new Error('loneliness should appear once'); });
      t('ui: btnPrimary fallback border is green', ()=>{ const s='1px solid '+(({primary:undefined})?.primary||'#16a34a'); if(s!=='1px solid #16a34a') throw new Error('green fallback missing'); });
      // extra test to ensure no pleasures when hunger<=2 and mood not bad
      t('no pleasures when hunger<=2 and mood ok even with old reasons', ()=>{ const r=buildRecommendations({binge:false,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:0,hunger_reason:['—É—Å—Ç–∞–ª–æ—Å—Ç—å']}); if(r.some(b=>b.title.includes('—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π'))) throw new Error('pleasures should not appear with hunger<=2'); });
      // extra: updated parents/guests wording present
      t('binge context parents text updated', ()=>{ const r=buildRecommendations({binge:true,binge_context:['—É —Ä–æ–¥–∏—Ç–µ–ª–µ–π'],mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',hunger:0}); const has=r[0].items.some(x=>/–ø–∞—É–∑—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º –±–ª—é–¥–æ–º/.test(x)); if(!has) throw new Error('updated parents advice missing'); });
      // exists: RelapseHelpCard
      t('component exists: RelapseHelpCard', ()=>{ if(typeof RelapseHelpCard !== 'function') throw new Error('RelapseHelpCard missing'); });
      return results;
    }

    // ===== App =====
    const App = () => {
      const tg = useTelegram();
      const theme = useTheme();
      const INITIAL_STATE = {hunger:0,mood:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',binge:false,binge_context:[],hunger_reason:[],seen_plate:false};
      const [screen,setScreen] = React.useState('checkin');
      const [i,setI] = React.useState(0);
      const [state,setState] = React.useState(INITIAL_STATE);
      const [tests] = React.useState(()=>runTests());

      const steps = computeSteps(state);
      const step = steps[i] || 'summary';

      function next(){ if(step==='summary'){ setScreen('done'); return; } setI(prev=> Math.min(prev+1, steps.length-1)); }
      function back(){ setI(prev=> Math.max(prev-1, 0)); }

      React.useEffect(()=>{ logEvent('app_open'); },[]);

      return (
        <div style={{background:theme.bg,color:theme.text,minHeight:"100vh"}}>
          <div style={{maxWidth:560,margin:"0 auto",padding:16}}>
            <Header theme={theme} onOpenProtocol={()=>{ logEvent('open_protocol'); setScreen('protocol'); }} onRelapse={()=>{ logEvent('relapse_info_open'); setScreen('relapse'); }} />

            {screen==='protocol' ? (<ProtocolCard theme={theme} onBack={()=>setScreen('checkin')} />)
             : screen==='relapse' ? (<RelapseHelpCard theme={theme} onBack={()=>setScreen('checkin')} />)
             : screen==='foods' ? (<FoodsCard theme={theme} onBack={()=>{ setScreen('checkin'); }} />)
             : screen==='water' ? (<WaterCard theme={theme} onBack={()=>{ setScreen('checkin'); }} />)
             : screen==='done' ? (<DoneCard theme={theme} state={state} onRestart={()=>{ setScreen('checkin'); setI(0); setState(INITIAL_STATE); }} />)
             : (<CheckinCard theme={theme} i={i} step={step} state={state} setState={setState} next={next} back={back} onRestart={()=>{ setScreen('checkin'); setI(0); }} />)}

            {/* –ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º */}
            <div style={{marginTop:12}}>
              <Section theme={theme} title="–ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã">
                <div style={{display:'grid',gap:8,marginTop:12}}>
                  <div onClick={()=>{ logEvent('materials_click', { materials_click: 'water_guide' }); setScreen('water'); }}
                       style={{display:'flex',gap:12,alignItems:'center',padding:'10px 12px',border:'1px solid '+(theme?.border||'#e5e7eb'),borderRadius:12,cursor:'pointer',textDecoration:'none'}}>
                    <div style={{fontSize:20}}>üíß</div>
                    <div style={{fontWeight:600}}>–ì–∞–π–¥ –ø–æ –≤–æ–¥–µ</div>
                  </div>
                  <div onClick={()=>{ logEvent('materials_click', { materials_click: 'foods' }); setScreen('foods'); }}
                       style={{display:'flex',gap:12,alignItems:'center',padding:'10px 12px',border:'1px solid '+(theme?.border||'#e5e7eb'),borderRadius:12,cursor:'pointer',textDecoration:'none'}}>
                    <div style={{fontSize:20}}>üß∫</div>
                    <div style={{fontWeight:600}}>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
                  </div>
                </div>
              </Section>
            </div>

          </div>
        </div>
      )
    }

    // Robust mount: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ React –¥–æ—Å—Ç—É–ø–µ–Ω
    (function mount(){
      try{
        if(typeof ReactDOM==='object' && ReactDOM.createRoot && typeof React==='object'){
          const container = document.getElementById('root');
          const root = ReactDOM.createRoot(container);
          root.render(<App />);
        } else { setTimeout(mount, 16); }
      }catch(e){ __showFatal(e); throw e; }
    })();
  </script>
</body>
</html>
